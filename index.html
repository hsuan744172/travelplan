<!DOCTYPE html>
<html>
<head>
    <title>å³æ™‚æ´»å‹•æ¨è–¦å°èˆª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; }
        #map { height: 100vh; width: 100%; z-index: 0;}
        
        /* é¢æ¿æ¨£å¼ */
        #panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15); 
            width: 360px; 
            height: 90vh; 
            display: flex; flex-direction: column;
            border: 1px solid #fff;
        }
        
        .header-row { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        h3 { margin: 0; color: #2c3e50; font-size: 18px; font-weight: 800; text-align: center; }
        
        input[type="text"], input[type="date"], select { 
            width: 100%; padding: 12px; margin-bottom: 10px; 
            border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
            background: #fcfcfc; font-size: 14px;
        }
        input:focus, select:focus { outline: none; border-color: #2196F3; background: white; }
        
        button#btn { 
            width: 100%; padding: 14px; margin-top: 5px;
            background: linear-gradient(135deg, #2196F3, #1976D2); 
            color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; font-size: 15px;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
            transition: transform 0.1s; flex-shrink: 0;
        }
        button#btn:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        #list-container { flex-grow: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        
        /* AI æ¨è–¦å¡ç‰‡ */
        #ai-box { margin-bottom: 15px; display: none; }
        .ai-title { font-size: 13px; color: #2e7d32; font-weight: 900; margin-bottom: 8px; display: flex; align-items: center; }
        .ai-card { background: white; border: 1px solid #a5d6a7; border-radius: 8px; margin-bottom: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-header { padding: 12px; cursor: pointer; font-size: 14px; font-weight: bold; color: #1b5e20; display: flex; justify-content: space-between; align-items: center; background: #e8f5e9; }
        .ai-header:hover { background-color: #c8e6c9; }
        .ai-header::after { content: 'â–¼'; font-size: 10px; color: #4caf50; }
        .ai-reason { padding: 12px; font-size: 14px; color: #444; background: #fff; border-top: 1px dashed #a5d6a7; display: none; line-height: 1.5; }
        .ai-card.active .ai-reason { display: block; }
        .ai-card.active .ai-header::after { transform: rotate(180deg); }

        #status { margin-top: 10px; color: #666; font-size: 13px; text-align: center; flex-shrink: 0;}
        
        .item { padding: 15px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; transition: background 0.2s; }
        .item:hover { background: #f5f9ff; }
        .dist-badge { background: #607d8b; color: white; font-size: 11px; padding: 4px 8px; border-radius: 6px; margin-right: 12px; min-width: 55px; text-align: center; font-weight: 700; flex-shrink: 0; }
        .info { flex-grow: 1; }
        .info b { color: #2c3e50; display: block; margin-bottom: 5px; font-size: 15px; }
        .info small { color: #7f8c8d; display: block; font-size: 13px; margin-bottom: 3px; }
        .nav-link { color: #2196F3; text-decoration: none; font-size: 13px; font-weight: bold; margin-top: 5px; display: inline-block;}
        
        /* æ²è»¸ç¾åŒ– */
        #list-container::-webkit-scrollbar { width: 6px; }
        #list-container::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
        #list-container::-webkit-scrollbar-track { background-color: #f1f1f1; }

        /* ğŸ”¥ TPASS æé†’æ¡†æ¨£å¼ */
        .tpass-toast {
            position: absolute; top: 20px; right: 20px; z-index: 2000;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white; padding: 15px 25px;
            border-radius: 50px; box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
            font-weight: bold; font-size: 14px;
            display: none; animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            align-items: center; gap: 10px;
        }
        .tpass-icon { font-size: 20px; }
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="tpassToast" class="tpass-toast">
    <span class="tpass-icon">ğŸšŒ</span>
    <span>å¦‚æœè¦æ­è»Šï¼Œè¨˜å¾—æ”œå¸¶ TPASS æœˆç¥¨ï¼</span>
</div>

<div id="panel">
    <div class="header-row">
        <h3>ğŸ“… å³æ™‚æ´»å‹•æ¨è–¦</h3>
    </div>
    
    <input type="text" id="startInput" placeholder="ğŸš© èµ·é» (ä¾‹: å°åŒ—101)">
    <input type="text" id="endInput" placeholder="ğŸ çµ‚é» (ä¾‹: æ·¡æ°´è€è¡—)">
    
    <div style="display:flex; gap:10px;">
        <input type="date" id="datePicker" style="flex:1">
        <select id="prefInput" style="flex:1">
            <option value="all">å…¨éƒ¨é¡¯ç¤º</option>
            <option value="éŸ³æ¨‚,æ¼”å”±æœƒ,æ¨‚åœ˜,æ¼”å¥,æ­Œå”±,æ´¾å°,ç¥­">ğŸµ éŸ³æ¨‚</option>
            <option value="å¸‚é›†,æ“ºæ”¤,æ–‡å‰µ,å˜‰å¹´è¯,å¤œå¸‚,æ”¤ä½,å•†åœˆ">ğŸª å¸‚é›†</option>
            <option value="å±•è¦½,è—æ–‡,ç¾è¡“,å±•æ¼”,ç•«å±•,æ”å½±,è—è¡“">ğŸ–¼ï¸ å±•è¦½</option>
            <option value="è¦ªå­,å…’ç«¥,å¯¶å¯¶,é«”é©—,å°è¦½,DIY,ç‡Ÿ,ç«¥">ğŸ‘¶ è¦ªå­</option>
            <option value="èŠ±,è³è¢,ç”Ÿæ…‹,è‡ªç„¶,æ­¥é“,è¢ç«èŸ²,æ«»èŠ±,æ¡èŠ±,è½ç¾½æ¾">ğŸŒ¸ è³èŠ±</option>
            <option value="ç¯€,æ…¶,å»Ÿæœƒ,é¶å¢ƒ,ç‡ˆæœƒ,è·¨å¹´,è€¶èª•,è–èª•">ğŸ® ç¯€æ…¶</option>
            <option value="é‹å‹•,è·¯è·‘,é¦¬æ‹‰æ¾,å¥èµ°,å–®è»Š,ç‘œçˆ,ç«¶è³½">ğŸƒ é‹å‹•</option>
        </select>
    </div>

    <button id="btn" onclick="startTrip()">ğŸ” æœå°‹æ²¿é€”æ´»å‹•</button>
    <div id="status">è¼¸å…¥åœ°é»é–‹å§‹è¦åŠƒ</div>
    
    <div id="list-container">
        <div id="ai-box"></div>
        <div id="list"></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([23.97, 120.96], 8); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
    var layerGroup = L.layerGroup().addTo(map);
    var routeLayer = null;

    document.getElementById('datePicker').valueAsDate = new Date();

    function formatDistance(km) {
        if (km < 1) return Math.round(km * 1000) + "m";
        return km.toFixed(1) + "km";
    }

    // åœ°å€è½‰åº§æ¨™ (å›å‚³å®Œæ•´åœ°å€ä¾› TPASS åˆ¤æ–·)
    async function getCoordinates(address) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&accept-language=zh-TW`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.length > 0) {
            return { lat: data[0].lat, lon: data[0].lon, displayName: data[0].display_name };
        }
        throw new Error(`æ‰¾ä¸åˆ°ã€Œ${address}ã€`);
    }

    function isNorthTaiwan(address) {
        const cities = ["å°åŒ—", "è‡ºåŒ—", "æ–°åŒ—", "åŸºéš†", "æ¡ƒåœ’"];
        return cities.some(city => address.includes(city));
    }

    async function startTrip() {
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const list = document.getElementById('list');
        const aiBox = document.getElementById('ai-box');
        const tpassToast = document.getElementById('tpassToast');
        const startName = document.getElementById('startInput').value.trim();
        const endName = document.getElementById('endInput').value.trim();

        tpassToast.style.display = 'none';

        if (!startName || !endName) {
            status.style.color = "#d32f2f";
            status.innerText = "âš ï¸ è«‹è¼¸å…¥èµ·é»èˆ‡çµ‚é»";
            return;
        }

        btn.disabled = true;
        btn.innerText = "è³‡æ–™åˆ†æä¸­...";
        list.innerHTML = "";
        aiBox.style.display = "none";
        layerGroup.clearLayers();
        status.style.color = "#666";
        status.innerText = "ğŸ” æ­£åœ¨è¦åŠƒè·¯å¾‘...";

        try {
            // 1. è½‰åº§æ¨™
            const startCoord = await getCoordinates(startName);
            const endCoord = await getCoordinates(endName);

            // ğŸ”¥ TPASS åˆ¤æ–·é‚è¼¯ (ä¿®æ”¹ç‰ˆï¼šé¡¯ç¤º 10 ç§’ + é»æ“Šé—œé–‰)
            if (isNorthTaiwan(startCoord.displayName) && isNorthTaiwan(endCoord.displayName)) {
                tpassToast.style.display = 'flex';
                // å¼·åˆ¶é‡ç¹ªï¼Œç¢ºä¿å‹•ç•«æœƒè·‘
                void tpassToast.offsetWidth; 
                tpassToast.style.opacity = '1';
                
                // è¨­å®š 10 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
                const hideTimeout = setTimeout(() => {
                    tpassToast.style.opacity = '0';
                    setTimeout(() => tpassToast.style.display = 'none', 500);
                }, 10000); // ğŸ‘ˆ é€™è£¡æ”¹æˆ 10000 (10ç§’)

                // âœ¨ æ–°å¢åŠŸèƒ½ï¼šä½¿ç”¨è€…é»ä¸€ä¸‹å°±ç«‹åˆ»é—œé–‰ (é¿å…æ“‹è·¯)
                tpassToast.onclick = () => {
                    clearTimeout(hideTimeout); // å–æ¶ˆè‡ªå‹•å€’æ•¸
                    tpassToast.style.opacity = '0';
                    setTimeout(() => tpassToast.style.display = 'none', 500);
                };
            }
            // 2. OSRM è·¯å¾‘
            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${startCoord.lon},${startCoord.lat};${endCoord.lon},${endCoord.lat}?overview=full`;
            const routeRes = await fetch(osrmUrl);
            const routeData = await routeRes.json();
            if (!routeData.routes.length) throw new Error("ç„¡æ³•è¦åŠƒè·¯å¾‘");
            
            const geometry = routeData.routes[0].geometry;
            const coords = decodePolyline(geometry);
            
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.polyline(coords, {color: '#1976D2', weight: 6, opacity: 0.8}).addTo(map);
            map.fitBounds(routeLayer.getBounds(), {padding: [50, 50]});
            
            L.marker([startCoord.lat, startCoord.lon]).addTo(layerGroup).bindPopup("èµ·é»");
            L.marker([endCoord.lat, endCoord.lon]).addTo(layerGroup).bindPopup("çµ‚é»");

            status.innerText = "ğŸ“¡ æ­£åœ¨æœå°‹æ²¿é€”æ´»å‹•...";

            // 3. å‘¼å«å¾Œç«¯
            const API_URL = "/api/proxy"; 

            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    geometry: geometry,
                    date: document.getElementById('datePicker').value,
                    preference: document.getElementById('prefInput').value,
                    lat: startCoord.lat,
                    lng: startCoord.lon
                }) 
            });

            if (!response.ok) throw new Error(`é€£ç·šå¤±æ•— (${response.status})`);
            const finalData = await response.json();

            // 4. è™•ç† AI æ¨è–¦
            if (finalData.ai_recommendation) {
                let aiText = finalData.ai_recommendation;
                try {
                    if (typeof aiText === 'string') {
                        aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                        let aiJson = JSON.parse(aiText);
                        if (!Array.isArray(aiJson)) aiJson = [aiJson];

                        let aiHtml = `<div class="ai-title">âœ¨ AI ç²¾é¸æ¨è–¦ (é»æ“ŠæŸ¥çœ‹è©³æƒ…)</div>`;
                        aiJson.forEach((rec, idx) => {
                            aiHtml += `
                                <div class="ai-card" onclick="this.classList.toggle('active')">
                                    <div class="ai-header">
                                        <span>${idx + 1}. ${rec.recommended_id}</span>
                                    </div>
                                    <div class="ai-reason">${rec.reason}</div>
                                </div>`;
                        });
                        aiBox.innerHTML = aiHtml;
                        aiBox.style.display = "block";
                    }
                } catch(e) { console.error(e); }
            }

            // 5. æ¸²æŸ“åˆ—è¡¨ (å«å…¨ç¨‹å°èˆªæŒ‰éˆ•)
            const spots = finalData.spots || [];
            if (spots.length === 0 || spots[0].category === "æç¤º") {
                status.style.color = "#e74c3c";
                status.innerText = spots[0]?.name || "æ­¤è·¯å¾‘ç„¡ç¬¦åˆæ´»å‹•";
            } else {
                status.style.color = "#2e7d32";
                status.innerText = `ğŸ‰ å·²æ‰¾åˆ° ${spots.length} å€‹æ´»å‹• (ä¾è·é›¢æ’åº)`;
                let listHtml = "";
                
                // ğŸ”¥ æ–°å¢ï¼šGoogle Maps å…¨ç¨‹å°èˆªæŒ‰éˆ• (å–å‰3å€‹)
                if (spots.length > 0) {
                    const waypoints = spots.slice(0, 3).map(s => `${s.lat},${s.lng}`).join('|');
                    const fullTripUrl = `https://www.google.com/maps/dir/?api=1&origin=${startCoord.lat},${startCoord.lon}&destination=${endCoord.lat},${endCoord.lon}&waypoints=${waypoints}&travelmode=driving`;
                    
                    listHtml += `
                        <a href="${fullTripUrl}" target="_blank" style="
                            display: block; margin-bottom: 15px; padding: 12px; 
                            background: #27ae60; color: white; text-align: center; 
                            border-radius: 8px; text-decoration: none; font-weight: bold;
                            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);">
                            ğŸš— ä¸€éµé–‹å•Ÿ Google Maps å…¨ç¨‹å°èˆª
                        </a>`;
                }

                spots.forEach((spot, index) => {
                    if (!spot.lat) return;
                    const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}`;
                    const distText = formatDistance(spot.distance);

                    const marker = L.marker([spot.lat, spot.lng])
                        .bindPopup(`<b>${spot.name}</b><br>${spot.time}<br><a href="${googleMapUrl}" target="_blank">é–‹å•Ÿå°èˆª</a>`)
                        .addTo(layerGroup);
                    
                    window[`zoomTo${index}`] = () => {
                        marker.openPopup();
                        map.setView([spot.lat, spot.lng], 16);
                    };

                    listHtml += `
                        <div class="item" onclick="zoomTo${index}()">
                            <div class="dist-badge">${distText}</div>
                            <div class="info">
                                <b>${spot.name}</b>
                                <small>ğŸ“… ${spot.time}</small>
                                <small>ğŸ“ ${spot.location}</small>
                                <a href="${googleMapUrl}" target="_blank" class="nav-link" onclick="event.stopPropagation()">â†— å–®é»å°èˆª</a>
                            </div>
                        </div>`;
                });
                list.innerHTML = listHtml;
            }

        } catch (e) {
            console.error(e);
            status.style.color = "red";
            status.innerText = "è¨Šæ¯: " + e.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸ” æœå°‹æ²¿é€”æ´»å‹•";
        }
    }

    function decodePolyline(str,precision){var index=0,lat=0,lng=0,coordinates=[],shift=0,result=0,byte=null,latitude_change,longitude_change,factor=Math.pow(10,precision||5);while(index<str.length){byte=null;shift=0;result=0;do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5}while(byte>=0x20);latitude_change=((result&1)?~(result>>1):(result>>1));shift=result=0;do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5}while(byte>=0x20);longitude_change=((result&1)?~(result>>1):(result>>1));lat+=latitude_change;lng+=longitude_change;coordinates.push([lat/factor,lng/factor])}return coordinates}
</script>
</body>
</html>