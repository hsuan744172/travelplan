<!DOCTYPE html>
<html>
<head>
    <title>å³æ™‚æ´»å‹•èˆ‡ç¾é£Ÿå°èˆª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; }
        #map { height: 100vh; width: 100%; z-index: 0;}
        
        /* é¢æ¿æ¨£å¼ */
        #panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15); 
            width: 380px; /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´æ–°åŠŸèƒ½ */
            height: 90vh; 
            display: flex; flex-direction: column;
            border: 1px solid #fff;
        }
        
        .header-row { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        h3 { margin: 0; color: #2c3e50; font-size: 18px; font-weight: 800; text-align: center; }
        
        /* è¼¸å…¥èˆ‡æ§åˆ¶é … */
        input[type="text"], input[type="date"], select { 
            width: 100%; padding: 10px; margin-bottom: 8px; 
            border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
            background: #fcfcfc; font-size: 14px;
        }
        
        /* æœå°‹é¡å‹ Checkbox */
        .search-types { display: flex; gap: 15px; margin-bottom: 8px; justify-content: center; }
        .search-types label { font-size: 14px; font-weight: bold; color: #555; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .search-types input[type="checkbox"] { transform: scale(1.2); }

        button#btn { 
            width: 100%; padding: 12px; margin-top: 5px;
            background: linear-gradient(135deg, #2196F3, #1976D2); 
            color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; font-size: 15px;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
            flex-shrink: 0;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* æ”¶è—æ¸…å–®å€å¡Š (æ–°å¢) */
        #saved-section {
            background: #fff3e0; border: 1px solid #ffe0b2;
            border-radius: 8px; padding: 10px; margin-top: 10px;
            display: none; /* é è¨­éš±è—ï¼Œæœ‰æ”¶è—æ™‚æ‰é¡¯ç¤º */
        }
        .saved-title { font-size: 13px; font-weight: bold; color: #e65100; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        #saved-list { display: flex; flex-wrap: wrap; gap: 5px; }
        .saved-tag { 
            background: white; border: 1px solid #ffcc80; color: #e65100;
            padding: 4px 8px; border-radius: 12px; font-size: 12px; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        .saved-tag:hover { background: #ffe0b2; }
        .btn-plan-route {
            width: 100%; margin-top: 8px; padding: 8px;
            background: #e65100; color: white; border: none; border-radius: 6px;
            font-size: 13px; cursor: pointer; font-weight: bold;
        }

        /* æœå°‹çµæœåˆ—è¡¨ */
        #list-container { flex-grow: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        
        /* åˆ—è¡¨å–®é …æ¨£å¼ */
        .item { 
            padding: 12px 8px; border-bottom: 1px solid #f0f0f0; 
            display: flex; align-items: flex-start; transition: background 0.2s; position: relative;
        }
        .item:hover { background: #f5f9ff; }
        
        .type-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white;
            position: absolute; top: 12px; right: 40px; font-weight: bold;
        }
        .bg-food { background: #ff9800; }
        .bg-attraction { background: #2196F3; }

        /* æ„›å¿ƒæŒ‰éˆ• */
        .heart-btn {
            font-size: 20px; color: #ccc; cursor: pointer; margin-left: 10px;
            transition: transform 0.2s; padding: 5px;
        }
        .heart-btn:hover { transform: scale(1.2); }
        .heart-btn.active { color: #e91e63; }

        .dist-badge { background: #607d8b; color: white; font-size: 11px; padding: 4px 6px; border-radius: 6px; margin-right: 10px; min-width: 45px; text-align: center; margin-top: 2px;}
        .info { flex-grow: 1; padding-right: 5px;}
        .info b { color: #2c3e50; display: block; margin-bottom: 4px; font-size: 15px; }
        .info small { color: #7f8c8d; display: block; font-size: 12px; margin-bottom: 2px; }
        .nav-link { color: #2196F3; text-decoration: none; font-size: 12px; font-weight: bold; margin-top: 4px; display: inline-block;}

        /* AI å€å¡Šä¿æŒåŸæ¨£ */
        #ai-box { margin-bottom: 10px; display: none; margin-top: 10px;}
        .ai-title { font-size: 13px; color: #2e7d32; font-weight: 900; margin-bottom: 8px; }
        .ai-card { background: white; border: 1px solid #a5d6a7; border-radius: 8px; margin-bottom: 8px; overflow: hidden; }
        .ai-header { padding: 10px; cursor: pointer; font-size: 13px; font-weight: bold; color: #1b5e20; background: #e8f5e9; }
        .ai-reason { padding: 10px; font-size: 13px; color: #444; display: none; }
        .ai-card.active .ai-reason { display: block; }

        #status { margin-top: 5px; color: #666; font-size: 13px; text-align: center; flex-shrink: 0;}

        /* TPASS */
        .tpass-toast {
            position: absolute; top: 20px; right: 20px; z-index: 2000;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white; padding: 15px 25px;
            border-radius: 50px; box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
            font-weight: bold; font-size: 14px; display: none; align-items: center; gap: 10px;
        }
    </style>
</head>
<body>

<div id="tpassToast" class="tpass-toast">
    <span style="font-size:20px">ğŸšŒ</span>
    <span>å¦‚æœè¦æ­è»Šï¼Œè¨˜å¾—æ”œå¸¶ TPASS æœˆç¥¨ï¼</span>
</div>

<div id="panel">
    <div class="header-row">
        <h3>ğŸ“… æ—…éŠ & ç¾é£Ÿè¦åŠƒåŠ©æ‰‹</h3>
    </div>
    
    <input type="text" id="startInput" placeholder="ğŸš© èµ·é» (ä¾‹: å°åŒ—è»Šç«™)">
    <input type="text" id="endInput" placeholder="ğŸ çµ‚é» (ä¾‹: ç¤æºªæº«æ³‰)">
    
    <div style="display:flex; gap:5px;">
        <input type="date" id="datePicker" style="flex:1">
        <select id="prefInput" style="flex:1">
            <option value="all">ä¸é™èˆˆè¶£</option>
            <option value="éŸ³æ¨‚,å¸‚é›†,å±•è¦½">æ–‡é’ (å±•è¦½/å¸‚é›†)</option>
            <option value="è¦ªå­,é«”é©—,DIY">è¦ªå­ (é«”é©—/DIY)</option>
            <option value="è‡ªç„¶,æ­¥é“,èŠ±">æˆ¶å¤– (è‡ªç„¶/è³èŠ±)</option>
        </select>
    </div>

    <div class="search-types">
        <label><input type="checkbox" id="chkAttraction" checked> æ‰¾æ™¯é»</label>
        <label><input type="checkbox" id="chkFood" checked> æ‰¾ç¾é£Ÿ</label>
    </div>

    <button id="btn" onclick="startTrip()">ğŸ” æœå°‹æ²¿é€”å¥½å»è™•</button>
    
    <div id="saved-section">
        <div class="saved-title">
            <span>â¤ï¸ æˆ‘çš„è¡Œç¨‹æ¸…å–® (<span id="saved-count">0</span>)</span>
            <small style="color:#666; font-weight:normal;">é»æ“Šç§»é™¤</small>
        </div>
        <div id="saved-list"></div>
        <button class="btn-plan-route" onclick="openSavedRoute()">ğŸ—ºï¸ è¦åŠƒè¡Œç¨‹è·¯ç·š (Google Maps)</button>
    </div>

    <div id="status">è¼¸å…¥åœ°é»é–‹å§‹è¦åŠƒ</div>
    
    <div id="list-container">
        <div id="ai-box"></div>
        <div id="list"></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([23.97, 120.96], 8); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
    var layerGroup = L.layerGroup().addTo(map);
    var routeLayer = null;

    // å„²å­˜å…¨åŸŸè®Šæ•¸
    let currentStart = null;
    let currentEnd = null;
    let savedSpots = []; // æ”¶è—çš„æ™¯é»/ç¾é£Ÿ

    document.getElementById('datePicker').valueAsDate = new Date();

    function formatDistance(km) {
        return km < 1 ? Math.round(km * 1000) + "m" : km.toFixed(1) + "km";
    }

    async function getCoordinates(address) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&accept-language=zh-TW`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.length > 0) return { lat: data[0].lat, lon: data[0].lon, displayName: data[0].display_name };
        throw new Error(`æ‰¾ä¸åˆ°ã€Œ${address}ã€`);
    }

    function isNorthTaiwan(address) {
        const cities = ["å°åŒ—", "è‡ºåŒ—", "æ–°åŒ—", "åŸºéš†", "æ¡ƒåœ’"];
        return cities.some(city => address.includes(city));
    }

    // ---------------- ä¸»æµç¨‹ ----------------
    async function startTrip() {
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const list = document.getElementById('list');
        const aiBox = document.getElementById('ai-box');
        const tpassToast = document.getElementById('tpassToast');
        
        const startName = document.getElementById('startInput').value.trim();
        const endName = document.getElementById('endInput').value.trim();

        // å–å¾— Checkbox ç‹€æ…‹
        const searchTypes = [];
        if (document.getElementById('chkAttraction').checked) searchTypes.push('attractions');
        if (document.getElementById('chkFood').checked) searchTypes.push('food');

        if (!startName || !endName) {
            status.style.color = "#d32f2f"; status.innerText = "âš ï¸ è«‹è¼¸å…¥èµ·é»èˆ‡çµ‚é»"; return;
        }
        if (searchTypes.length === 0) {
            status.style.color = "#d32f2f"; status.innerText = "âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®æœå°‹é¡å‹"; return;
        }

        btn.disabled = true; btn.innerText = "è³‡æ–™åˆ†æä¸­...";
        list.innerHTML = ""; aiBox.style.display = "none";
        layerGroup.clearLayers();
        
        // åƒ…æ¸…é™¤è·¯å¾‘ç·šï¼Œä¿ç•™ä½¿ç”¨è€…çš„æ”¶è—æ¨™è¨˜(å¦‚æœéœ€è¦çš„è©±ï¼Œé€™è£¡ç°¡å–®èµ·è¦‹å…ˆå…¨æ¸…ï¼Œé‡ç¹ªæ”¶è—)
        // ç‚ºäº† UXï¼Œæˆ‘å€‘é€™è£¡æ¸…ç©ºï¼Œä½†å¾Œé¢æœƒåˆ¤æ–· savedSpots æ˜¯å¦åœ¨çµæœä¸­ä¾†æ±ºå®šæ„›å¿ƒç‹€æ…‹

        status.style.color = "#666"; status.innerText = "ğŸ” æ­£åœ¨è¦åŠƒè·¯å¾‘...";

        try {
            const startCoord = await getCoordinates(startName);
            const endCoord = await getCoordinates(endName);
            
            // å­˜èµ·ä¾†çµ¦æœ€å¾Œè¦åŠƒè·¯ç·šç”¨
            currentStart = startCoord;
            currentEnd = endCoord;

            // TPASS
            tpassToast.style.display = 'none';
            if (isNorthTaiwan(startCoord.displayName) && isNorthTaiwan(endCoord.displayName)) {
                tpassToast.style.display = 'flex';
                tpassToast.style.opacity = '1';
                const hideTimeout = setTimeout(() => {
                    tpassToast.style.opacity = '0';
                    setTimeout(() => tpassToast.style.display = 'none', 500);
                }, 10000);
                tpassToast.onclick = () => {
                    clearTimeout(hideTimeout);
                    tpassToast.style.opacity = '0';
                    setTimeout(() => tpassToast.style.display = 'none', 500);
                };
            }

            // OSRM
            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${startCoord.lon},${startCoord.lat};${endCoord.lon},${endCoord.lat}?overview=full`;
            const routeRes = await fetch(osrmUrl);
            const routeData = await routeRes.json();
            if (!routeData.routes.length) throw new Error("ç„¡æ³•è¦åŠƒè·¯å¾‘");
            
            const geometry = routeData.routes[0].geometry;
            const coords = decodePolyline(geometry);
            
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.polyline(coords, {color: '#1976D2', weight: 6, opacity: 0.8}).addTo(map);
            map.fitBounds(routeLayer.getBounds(), {padding: [50, 50]});
            
            L.marker([startCoord.lat, startCoord.lon]).addTo(layerGroup).bindPopup("èµ·é»");
            L.marker([endCoord.lat, endCoord.lon]).addTo(layerGroup).bindPopup("çµ‚é»");

            status.innerText = "ğŸ“¡ æ­£åœ¨æœå°‹æ²¿é€”æ™¯é»èˆ‡ç¾é£Ÿ...";

            // å‘¼å« API
            const API_URL = "/api/proxy"; 
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    geometry: geometry,
                    date: document.getElementById('datePicker').value,
                    preference: document.getElementById('prefInput').value,
                    searchTypes: searchTypes, // å‚³éæœå°‹é¡å‹
                    lat: startCoord.lat,
                    lng: startCoord.lon
                }) 
            });

            if (!response.ok) throw new Error(`é€£ç·šå¤±æ•—`);
            let rawData = await response.json();

            let finalData = Array.isArray(rawData) ? rawData[0] : rawData;
            
            if (finalData.ai_recommendation) {
                let aiText = finalData.ai_recommendation;
                try {
                    if (typeof aiText === 'string') {
                        // æ¸…é™¤ Markdown ç¬¦è™Ÿ
                        aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                        let aiJson = JSON.parse(aiText);
                        if (!Array.isArray(aiJson)) aiJson = [aiJson];

                        let aiHtml = `<div class="ai-title">âœ¨ AI ç²¾é¸æ¨è–¦ (é»æ“ŠæŸ¥çœ‹è©³æƒ…)</div>`;
                        aiJson.forEach((rec, idx) => {
                            aiHtml += `
                                <div class="ai-card" onclick="this.classList.toggle('active')">
                                    <div class="ai-header">
                                        <span>${idx + 1}. ${rec.recommended_id}</span>
                                    </div>
                                    <div class="ai-reason">${rec.reason}</div>
                                </div>`;
                        });
                        aiBox.innerHTML = aiHtml;
                        aiBox.style.display = "block"; // è¨˜å¾—æŠŠå®ƒæ‰“é–‹ï¼
                    }
                } catch(e) { console.error("AI è§£æéŒ¯èª¤", e); }
            }
            // æ¸²æŸ“åˆ—è¡¨
            const spots = finalData.spots || [];
            if (spots.length === 0 || spots[0].category === "æç¤º") {
                status.style.color = "#e74c3c";
                status.innerText = spots[0]?.name || "ç„¡ç¬¦åˆè³‡æ–™";
            } else {
                status.style.color = "#2e7d32";
                status.innerText = `ğŸ‰ æ‰¾åˆ° ${spots.length} å€‹åœ°é»`;
                let listHtml = "";
                
                spots.forEach((spot, index) => {
                    if (!spot.lat) return;
                    
                    // åˆ¤æ–·é¡å‹é¡è‰²
                    const typeColor = spot.type === 'food' ? '#ff9800' : '#2196F3'; // æ©˜è‰²ç¾é£Ÿï¼Œè—è‰²æ™¯é»
                    const typeClass = spot.type === 'food' ? 'bg-food' : 'bg-attraction';
                    const typeName = spot.type === 'food' ? 'ç¾é£Ÿ' : 'æ™¯é»';

                    // è£½ä½œ Marker (ä¸åŒé¡è‰²)
                    const markerHtml = `<div style="background:${typeColor}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 3px black;"></div>`;
                    const icon = L.divIcon({ className: 'custom-div-icon', html: markerHtml, iconSize: [16, 16] });
                    
                    const marker = L.marker([spot.lat, spot.lng], {icon: icon})
                        .bindPopup(`<b>${spot.name}</b><br>${spot.category}`)
                        .addTo(layerGroup);

                    // æª¢æŸ¥æ˜¯å¦å·²æ”¶è—
                    const isSaved = savedSpots.some(s => s.name === spot.name);
                    const heartClass = isSaved ? 'active' : '';

                    window[`zoomTo${index}`] = () => {
                        marker.openPopup();
                        map.setView([spot.lat, spot.lng], 16);
                    };

                    // æ³¨æ„ï¼šé€™è£¡å°‡ spot ç‰©ä»¶è½‰æˆå­—ä¸²å¡å…¥ toggleSave
                    // ç‚ºäº†é¿å…å¼•è™Ÿå•é¡Œï¼Œç°¡å–® encode
                    const spotStr = encodeURIComponent(JSON.stringify(spot));

                    listHtml += `
                        <div class="item" onclick="zoomTo${index}()">
                            <div class="dist-badge">${formatDistance(spot.distance)}</div>
                            <div class="info">
                                <b>${spot.name}</b>
                                <span class="type-badge ${typeClass}">${typeName}</span>
                                <small>${spot.category} | ${spot.time}</small>
                                <small>ğŸ“ ${spot.location}</small>
                                <a href="https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}" target="_blank" class="nav-link" onclick="event.stopPropagation()">â†— æŸ¥çœ‹åœ°åœ–</a>
                            </div>
                            <div class="heart-btn ${heartClass}" onclick="event.stopPropagation(); toggleSave(this, '${spotStr}')">
                                â¤
                            </div>
                        </div>`;
                });
                list.innerHTML = listHtml;
            }

        } catch (e) {
            console.error(e);
            status.style.color = "red";
            status.innerText = "è¨Šæ¯: " + e.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸ” æœå°‹æ²¿é€”å¥½å»è™•";
        }
    }

    // ---------------- æ”¶è—æ¸…å–®é‚è¼¯ ----------------
    function toggleSave(btn, spotStr) {
        const spot = JSON.parse(decodeURIComponent(spotStr));
        const index = savedSpots.findIndex(s => s.name === spot.name);
        
        if (index === -1) {
            // åŠ å…¥æ”¶è—
            savedSpots.push(spot);
            btn.classList.add('active');
        } else {
            // ç§»é™¤æ”¶è—
            savedSpots.splice(index, 1);
            btn.classList.remove('active');
        }
        renderSavedList();
    }

    function removeSaved(name) {
        savedSpots = savedSpots.filter(s => s.name !== name);
        // åŒæ­¥æ›´æ–°åˆ—è¡¨ä¸­çš„æ„›å¿ƒç‹€æ…‹ (å¦‚æœé‚„åœ¨ç•«é¢ä¸Šçš„è©±)
        const items = document.querySelectorAll('.item');
        items.forEach(item => {
            const b = item.querySelector('b');
            if (b && b.innerText === name) {
                item.querySelector('.heart-btn').classList.remove('active');
            }
        });
        renderSavedList();
    }

    function renderSavedList() {
        const section = document.getElementById('saved-section');
        const container = document.getElementById('saved-list');
        const countSpan = document.getElementById('saved-count');
        
        countSpan.innerText = savedSpots.length;
        
        if (savedSpots.length === 0) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        let html = "";
        savedSpots.forEach(s => {
            html += `<div class="saved-tag" onclick="removeSaved('${s.name}')">${s.name} âœ–</div>`;
        });
        container.innerHTML = html;
    }

    function openSavedRoute() {
        if (!currentStart || !currentEnd) {
            alert("è«‹å…ˆæœå°‹ä¸¦è¨­å®šèµ·é»çµ‚é»");
            return;
        }
        if (savedSpots.length === 0) {
            alert("è«‹å…ˆé»æ“Šæ„›å¿ƒæ”¶è—æ™¯é»æˆ–ç¾é£Ÿ");
            return;
        }

        // å»ºæ§‹ Google Maps URL
        // æ ¼å¼: origin=...&destination=...&waypoints=lat,lng|lat,lng...
        const origin = `${currentStart.lat},${currentStart.lon}`;
        const dest = `${currentEnd.lat},${currentEnd.lon}`;
        const waypoints = savedSpots.map(s => `${s.lat},${s.lng}`).join('|');
        
        const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&waypoints=${waypoints}&travelmode=driving`;
        window.open(url, '_blank');
    }

    function decodePolyline(str,precision){var index=0,lat=0,lng=0,coordinates=[],shift=0,result=0,byte=null,latitude_change,longitude_change,factor=Math.pow(10,precision||5);while(index<str.length){byte=null;shift=0;result=0;do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5}while(byte>=0x20);latitude_change=((result&1)?~(result>>1):(result>>1));shift=result=0;do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5}while(byte>=0x20);longitude_change=((result&1)?~(result>>1):(result>>1));lat+=latitude_change;lng+=longitude_change;coordinates.push([lat/factor,lng/factor])}return coordinates}
</script>
</body>
</html>